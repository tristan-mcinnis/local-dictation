<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Debug Logs</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      background: #1e1e1e;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      user-select: text;
    }
    
    .header {
      padding: 20px;
      background: #2d2d2d;
      border-bottom: 1px solid #3e3e3e;
      -webkit-app-region: drag;
      padding-top: 30px;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      -webkit-app-region: no-drag;
    }
    
    button {
      padding: 8px 16px;
      background: #3e3e3e;
      color: #e0e0e0;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #4a4a4a;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button.primary {
      background: #007AFF;
      color: white;
    }
    
    button.primary:hover {
      background: #0066d6;
    }
    
    .filter-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .filter-btn {
      padding: 4px 10px;
      background: transparent;
      border: 1px solid #3e3e3e;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .filter-btn.active {
      background: #007AFF;
      border-color: #007AFF;
      color: white;
    }
    
    .logs-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-size: 12px;
      line-height: 1.5;
    }
    
    .log-entry {
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 2px;
      word-wrap: break-word;
      display: flex;
      gap: 10px;
    }
    
    .log-time {
      color: #808080;
      min-width: 80px;
    }
    
    .log-level {
      min-width: 60px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .log-message {
      flex: 1;
    }
    
    .log-entry.info {
      background: rgba(0, 122, 255, 0.1);
    }
    
    .log-entry.info .log-level {
      color: #007AFF;
    }
    
    .log-entry.success {
      background: rgba(76, 217, 100, 0.1);
    }
    
    .log-entry.success .log-level {
      color: #4cd964;
    }
    
    .log-entry.warning {
      background: rgba(255, 204, 0, 0.1);
    }
    
    .log-entry.warning .log-level {
      color: #ffcc00;
    }
    
    .log-entry.error {
      background: rgba(255, 59, 48, 0.1);
    }
    
    .log-entry.error .log-level {
      color: #ff3b30;
    }
    
    .log-entry.debug {
      background: rgba(100, 100, 100, 0.1);
      opacity: 0.7;
    }
    
    .log-entry.debug .log-level {
      color: #808080;
    }
    
    .stats {
      padding: 10px 20px;
      background: #2d2d2d;
      border-top: 1px solid #3e3e3e;
      font-size: 12px;
      display: flex;
      gap: 20px;
    }
    
    .stat {
      display: flex;
      gap: 5px;
    }
    
    .stat-label {
      color: #808080;
    }
    
    .stat-value {
      font-weight: bold;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #808080;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #4a4a4a;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #5a5a5a;
    }
    
    .error-codes {
      margin-top: 20px;
      padding: 15px;
      background: #2d2d2d;
      border-radius: 8px;
    }
    
    .error-codes h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #ff3b30;
    }
    
    .error-code-item {
      display: flex;
      gap: 10px;
      margin-bottom: 5px;
      font-size: 12px;
    }
    
    .error-code {
      color: #ff3b30;
      font-weight: bold;
      min-width: 60px;
    }
    
    .error-desc {
      color: #d0d0d0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Debug Logs</h1>
    <div class="controls">
      <button onclick="clearLogs()">Clear Logs</button>
      <button onclick="exportLogs()">Export Logs</button>
      <button onclick="toggleAutoScroll()" id="autoscroll-btn" class="primary">Auto-scroll: ON</button>
    </div>
    <div class="filter-group">
      <button class="filter-btn active" onclick="setFilter('all', event)">All</button>
      <button class="filter-btn" onclick="setFilter('error', event)">Errors</button>
      <button class="filter-btn" onclick="setFilter('warning', event)">Warnings</button>
      <button class="filter-btn" onclick="setFilter('info', event)">Info</button>
      <button class="filter-btn" onclick="setFilter('success', event)">Success</button>
      <button class="filter-btn" onclick="setFilter('debug', event)">Debug</button>
    </div>
  </div>
  
  <div class="logs-container" id="logs">
    <div class="empty-state">
      <h2>No logs yet</h2>
      <p>Debug logs will appear here as the app runs</p>
    </div>
  </div>
  
  <div class="stats">
    <div class="stat">
      <span class="stat-label">Total:</span>
      <span class="stat-value" id="stat-total">0</span>
    </div>
    <div class="stat">
      <span class="stat-label">Errors:</span>
      <span class="stat-value" id="stat-errors" style="color: #ff3b30;">0</span>
    </div>
    <div class="stat">
      <span class="stat-label">Warnings:</span>
      <span class="stat-value" id="stat-warnings" style="color: #ffcc00;">0</span>
    </div>
    <div class="stat">
      <span class="stat-label">Avg Cycle:</span>
      <span class="stat-value" id="avg-cycle" style="color: #4cd964;">-</span>
    </div>
    <div class="stat">
      <span class="stat-label">Session:</span>
      <span class="stat-value" id="session-time">00:00:00</span>
    </div>
  </div>
  
  <script>
    const { ipcRenderer } = require('electron');
    const fs = require('fs');
    const path = require('path');
    
    let logs = [];
    let currentFilter = 'all';
    let autoScroll = true;
    let sessionStart = Date.now();
    let stats = {
      total: 0,
      errors: 0,
      warnings: 0,
      info: 0,
      success: 0,
      debug: 0
    };
    let cycleTimes = [];
    
    // Error code definitions
    const ERROR_CODES = {
      'E001': 'Failed to start Python backend',
      'E002': 'Python process crashed',
      'E003': 'Audio recording failed',
      'E004': 'Transcription failed',
      'E005': 'Failed to type text',
      'E006': 'Hotkey registration failed',
      'E007': 'Model loading failed',
      'E008': 'No audio input detected',
      'E009': 'Microphone permission denied',
      'E010': 'Whisper model not found'
    };
    
    function formatTime(date) {
      return date.toTimeString().split(' ')[0];
    }
    
    function getLogLevel(message) {
      if (message.includes('ERROR') || message.includes('error') || message.includes('Failed')) return 'error';
      if (message.includes('WARNING') || message.includes('warning')) return 'warning';
      if (message.includes('SUCCESS') || message.includes('success') || message.includes('TYPED')) return 'success';
      if (message.includes('DEBUG') || message.includes('debug')) return 'debug';
      if (message.includes('READY') || message.includes('START') || message.includes('STOP')) return 'info';
      return 'info';
    }
    
    function detectErrorCode(message) {
      if (message.includes('Failed to start Python')) return 'E001';
      if (message.includes('Python process exited')) return 'E002';
      if (message.includes('Audio recording')) return 'E003';
      if (message.includes('Transcription')) return 'E004';
      if (message.includes('Failed to type')) return 'E005';
      if (message.includes('Hotkey')) return 'E006';
      if (message.includes('Model')) return 'E007';
      if (message.includes('No audio')) return 'E008';
      if (message.includes('Microphone permission')) return 'E009';
      if (message.includes('Whisper model not found')) return 'E010';
      return null;
    }
    
    function addLog(message, level = null, metrics = null) {
      const now = new Date();
      const logLevel = level || getLogLevel(message);
      const errorCode = detectErrorCode(message);
      
      const log = {
        time: formatTime(now),
        level: logLevel,
        message: message,
        errorCode: errorCode,
        timestamp: now.getTime(),
        metrics: metrics
      };
      
      logs.push(log);
      stats.total++;
      stats[logLevel]++;
      
      // Track cycle times
      if (message.includes('Full cycle completed') && metrics) {
        cycleTimes.push(metrics);
        if (cycleTimes.length > 10) cycleTimes.shift(); // Keep last 10
        updateAvgCycle();
      }
      
      if (currentFilter === 'all' || currentFilter === logLevel) {
        renderLog(log);
      }
      
      updateStats();
      
      if (autoScroll) {
        const container = document.getElementById('logs');
        container.scrollTop = container.scrollHeight;
      }
    }
    
    function renderLog(log) {
      const container = document.getElementById('logs');
      
      if (logs.length === 1 && container.querySelector('.empty-state')) {
        container.innerHTML = '';
      }
      
      const entry = document.createElement('div');
      entry.className = `log-entry ${log.level}`;
      
      const errorCodeText = log.errorCode ? `[${log.errorCode}] ` : '';
      const metricsText = log.metrics ? ` (${log.metrics}ms)` : '';
      
      entry.innerHTML = `
        <span class="log-time">${log.time}</span>
        <span class="log-level">${log.level}</span>
        <span class="log-message">${errorCodeText}${escapeHtml(log.message)}${metricsText ? '<strong style="color: #ffcc00;">' + metricsText + '</strong>' : ''}</span>
      `;
      
      container.appendChild(entry);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function renderAllLogs() {
      const container = document.getElementById('logs');
      container.innerHTML = '';
      
      const filteredLogs = currentFilter === 'all' 
        ? logs 
        : logs.filter(log => log.level === currentFilter);
      
      if (filteredLogs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h2>No ${currentFilter} logs</h2>
            <p>No logs matching the current filter</p>
          </div>
        `;
        return;
      }
      
      filteredLogs.forEach(log => renderLog(log));
    }
    
    function setFilter(filter, evt) {
      currentFilter = filter;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      if (evt && evt.target) {
        evt.target.classList.add('active');
      }
      
      renderAllLogs();
    }
    
    function clearLogs() {
      logs = [];
      stats = {
        total: 0,
        errors: 0,
        warnings: 0,
        info: 0,
        success: 0,
        debug: 0
      };
      sessionStart = Date.now();
      renderAllLogs();
      updateStats();
    }
    
    function exportLogs() {
      const content = logs.map(log => 
        `[${log.time}] [${log.level.toUpperCase()}] ${log.errorCode ? `[${log.errorCode}] ` : ''}${log.message}`
      ).join('\n');
      
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `debug-logs-${timestamp}.txt`;
      const filepath = path.join(require('electron').remote.app.getPath('downloads'), filename);
      
      fs.writeFileSync(filepath, content, 'utf8');
      
      addLog(`Logs exported to ${filename}`, 'success');
    }
    
    function toggleAutoScroll() {
      autoScroll = !autoScroll;
      const btn = document.getElementById('autoscroll-btn');
      btn.textContent = `Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
      btn.className = autoScroll ? 'primary' : '';
    }
    
    function updateStats() {
      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-errors').textContent = stats.errors;
      document.getElementById('stat-warnings').textContent = stats.warnings;
    }
    
    function updateAvgCycle() {
      if (cycleTimes.length > 0) {
        const avg = Math.round(cycleTimes.reduce((a, b) => a + b, 0) / cycleTimes.length);
        document.getElementById('avg-cycle').textContent = `${avg}ms`;
      }
    }
    
    function updateSessionTime() {
      const elapsed = Date.now() - sessionStart;
      const hours = Math.floor(elapsed / 3600000);
      const minutes = Math.floor((elapsed % 3600000) / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      
      document.getElementById('session-time').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Update session time every second
    setInterval(updateSessionTime, 1000);
    
    // Listen for log messages from main process
    ipcRenderer.on('log-message', (event, data) => {
      addLog(data.message, data.level, data.metrics);
    });
    
    // Request initial logs
    ipcRenderer.send('request-logs');
  </script>
</body>
</html>